{% from "table/macro.njk" import govukTable %}
{% extends "layout.html" %}
{% block pageTitle %}
Find an Energy Performance Certificate
{% endblock %}
{% block header %}
<!-- Blank header with no service name for the start page -->
{{ govukHeader() }}
{% endblock %}
{% block beforeContent %}
{{ super() }}
<div class="govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
    <li class="govuk-breadcrumbs__list-item">
      <a class="govuk-back-link" href="javascript: window.history.go(-1)">Back</a>
    </li>
  </ol>
</div>
{% endblock %}
{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
     <form id="main" action="{{ content.data.NextStepUrl.en }}" method="post" class="form" novalidate>
        
        <div class="govuk-error-summary hide" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="error-summary">
          <h2 class="govuk-error-summary__title " id="error-summary-title">
            There is a problem
          </h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
            </ul>
          </div>
        </div>

        <div class="govuk-form-group"> 
          <fieldset class="govuk-fieldset" aria-describedby="search-field-hint">

            <legend class="govuk-fieldset__legend govuk-fieldset__legend--xl">
              <h1 class="govuk-fieldset__heading">
                Search results for {{ data['search-field'] }}
              </h1>
            </legend>
            
            <span id="search-field-hint" class="govuk-hint">
              Use the address and postcode (eg DY10 1AA, SW1P 3BU)
            </span>

            <div class="">
              <label class="govuk-label" for="search-field">
                Enter a postcode, certificate or assessor reference.
              </label>
              <span id="search-field-error" class="govuk-error-message hide">
                Enter the postcode, certificate or assessor reference.
              </span>
              <input data-required="true" class="govuk-input" id="search-field" name="search-field" type="text" value="{{ data['search-field'] }}"> 
            </div>
          </fieldset>
        </div>

        {{ govukButton({
          text: "Find the property"
        }) }}

      </form>
  </div>
</div>


<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-quarter">
    <p>FILTER</p>
    {% include "includes/filter.html" %}
  </div>
  <div class="govuk-grid-column-three-quarters">
    <div class="govuk-tabs" data-module="tabs">
      <h2 class="govuk-tabs__title">
        Results for {{ data['search-field'] }}
      </h2>
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#all">
          All ({{ (response.addresses.length+response.certificates.length+ response.assessors.length) }})</a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#postcodes">
          Postcodes ({{ response.addresses.length }})</a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#certificates">
          Certificates ({{ response.certificates.length }})</a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab govuk-tabs__tab--selected" href="#assessors">
          Assessors ({{ response.assessors.length }})</a>
        </li>
      </ul>



      <section class="govuk-tabs__panel govuk-tabs__panel--hidden" id="postcodes">
        <h2 class="govuk-heading-l">Properties for {{ data['search-field'] }}</h2>
        <!--  Addresses for postcode  -->
        {% if not response.addresses.length %}
        <p>No addresses found for that postcode</p>
        {% else %}
        <table class="govuk-table">
          <caption class="govuk-table__caption">All properties for {{ data['search-field'] }}:
          {{response.addresses[0].street}}, {{response.addresses[0].town | capitalize}}</caption>
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th class="govuk-table__header" scope="col">Name</th>
              <th class="govuk-table__header" scope="col">Number</th>
              <th class="govuk-table__header" scope="col">Street</th>
              <th class="govuk-table__header" scope="col">Town</th>
              <!-- <th class="govuk-table__header" scope="col">Postcode</th> -->
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for item in response.addresses %}
            <tr class="govuk-table__row">
              <th class="govuk-table__header" scope="row">{{item.name}}</th>
              <td class="govuk-table__cell">{{item.number}}</td>
              <td class="govuk-table__cell">{{item.street}}</td>
              <td class="govuk-table__cell">{{item.town | capitalize}}</td>
              <!-- <td class="govuk-table__cell">{{item.postcode}}</td> -->
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      <section class="govuk-tabs__panel govuk-tabs__panel--hidden" id="certificates">
        <h2 class="govuk-heading-l">Certificates for {{ data['search-field'] }}</h2>
        <!--  Certificate for postcode  -->
        {% if not response.certificates.length %}
        <p>No certificates found for that postcode</p>
        {% else %}
        <p>Please click on a certificate below to view or download a report:</p>
        <table class="govuk-table">
          <caption class="govuk-table__caption">All certificates for {{ data['search-field'] }}:
          {{response.addresses[0].street}}, {{response.addresses[0].town | capitalize}}</caption>
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th class="govuk-table__cell" scope="col">Number</th>
              <th class="govuk-table__cell" scope="col">Name</th>
              <th class="govuk-table__cell" scope="col">Street</th>
              <th class="govuk-table__cell" scope="col">Town</th>
              <!-- <th class="govuk-table__cell" scope="col">Postcode</th> -->
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for item in response.certificates %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell"><a href="certificate/{{item.reference}}">{{item.number}}</a></td>
              <th class="govuk-table__cell" scope="row">{{item.name}}</th>
              <td class="govuk-table__cell">{{item.street}}</td>
              <td class="govuk-table__cell">{{item.town | capitalize}}</td>
              <!-- <td class="govuk-table__cell">{{item.postcode}}</td> -->
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      <section class="govuk-tabs__panel" id="assessors">
        <h2 class="govuk-heading-l">Assessors for {{ data['search-field'] }}</h2>
        <!--  assessors for postcode  -->
        {% if not response.assessors.length %}
        <p>No assessors found for that postcode</p>
        {% else %}
        <p>Please click on an assessor below to view further details:</p>

        <form id="form-sort" class="js-auto-submit__form" action="results" method="post" >
          <input type="hidden" name=":uri" value="search">
          <input type="hidden" name="size" value="10">
          <input type="hidden" name="q" value="gdp" class="js-auto-submit__input">
          <div class="js-mobile-filters__sort">
            <label for="sort" class="sort__label">Sort by
              <select class="input select select--thin width-auto js-auto-submit__input" id="sort" name="sortBy">
                <option class="sort__option" value="number_desc">Number desc
                </option>
                <option class="sort__option" value="number_asc">Number asc
                </option>
                <option class="sort__option" value="name_desc">Name desc
                </option>
                <option class="sort__option" value="name_asc">Name asc
                </option>
              </select>
            </label>
            <button id="sortBtn" type="submit" class="btn btn--primary btn--thin btn--small js--hide">Sort</button>
          </div>
        </form>

        <table class="govuk-table">
          <caption class="govuk-table__caption">Local assessors</caption>
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th class="govuk-table__cell" scope="col">Accreditation</th>
              <th class="govuk-table__cell" scope="col">Name</th>
              <th class="govuk-table__cell" scope="col">Address</th>
              <th class="govuk-table__cell" scope="col">Telephone</th>
              <!--       <th class="govuk-table__cell" scope="col">Distance (miles)</th> -->
              <th class="govuk-table__cell" scope="col">Status</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for item in response.assessors %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">
                <a href="assessor/{{ item['base64ref'] }}">{{item['Accreditation Number']}}
                </a></td>
              <td class="govuk-table__cell">{{item['Assessor Name']}}</td>
              <td class="govuk-table__cell">{{item.Address}}</td>
              <td class="govuk-table__cell">{{item['Telephone Number']}}</td>
              <!--           <td class="govuk-table__cell">{{item.Distance}}</td> -->
              <td class="govuk-table__cell">{{item.Status}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
    </div>
  </div>
</div><!--  end of tab sections  -->

{% endblock %}
  {% block scripts %}
    <script>
      console.log('page script');
      var btn = document.getElementById("filterBtn");
      console.log(btn);
var results = [];//{{ response.assessors }};
var obj;

// is there a way to pass this object into js?
// load the js in order to be able to filter and sort in the page
{% for item in response.assessors %}
obj = {
    "Accreditation Number": "{{item['Accreditation Number']}}",
    "Assessor Name": "{{item['Assessor Name']}}",
    "Address": "{{item.Address}}",
    "Telephone Number": "{{item['Telephone Number']}}",
    "Distance": "{{item.Distance}}",
    "Status": "{{item.Status}}",
    "type":"{{item.type}}"
  }
results.push(obj)
{% endfor %} 
{% for item in response.certificates %}
var obj = {
    "name": "{{item.name}}",
    "number": "{{item.number}}",
    "street": "{{item.street}}",
    "town": "{{item.town | capitalize}}",
    "postcode": "{{item.postcode}}",
    "type":"certificate"
  }
results.push(obj)
{% endfor %} 
{% for item in response.addresses %}
var obj = {
    "name": "{{item.name}}",
    "number": "{{item.number}}",
    "street": "{{item.street}}",
    "town": "{{item.town | capitalize}}",
    "postcode": "{{item.postcode}}",
    "type":"{{item.type}}"
  }
results.push(obj)
{% endfor %} 
console.log(results);
    </script>


  {% endblock %}